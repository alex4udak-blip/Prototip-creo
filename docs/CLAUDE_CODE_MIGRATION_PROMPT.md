# BannerGen v2: –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ Gemini 3 Pro Image

## –ó–ê–î–ê–ß–ê

–ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å BannerGen —Å —Ç–µ–∫—É—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã (Claude + Imagen 3) –Ω–∞ –Ω–æ–≤—É—é (Gemini 3 Pro Image / Nano Banana Pro).

**–ì–ª–∞–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ —Å–µ–π—á–∞—Å:** Imagen 3 –Ω–µ –≤–∏–¥–∏—Ç –∫–∞—Ä—Ç–∏–Ω–∫–∏. –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º 4-5 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ Claude —á—Ç–æ–±—ã –æ–ø–∏—Å–∞—Ç—å —Ä–µ—Ñ–µ—Ä–µ–Ω—Å —Å–ª–æ–≤–∞–º–∏, –ø–æ—Ç–æ–º –ø–µ—Ä–µ–¥–∞—ë–º —Ç–µ–∫—Å—Ç –≤ Imagen. –≠—Ç–æ –∫–æ—Å—Ç—ã–ª–∏ –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ.

**–†–µ—à–µ–Ω–∏–µ:** Gemini 3 Pro Image ‚Äî —ç—Ç–æ LLM –∫–æ—Ç–æ—Ä—ã–π –Ω–∞—Ç–∏–≤–Ω–æ –≤–∏–¥–∏—Ç –∫–∞—Ä—Ç–∏–Ω–∫–∏ –ò –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏—Ö. –û–¥–Ω–∞ –º–æ–¥–µ–ª—å –¥–µ–ª–∞–µ—Ç –≤—Å—ë.

---

## –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û

### –ú–æ–¥–µ–ª—å –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
```
gemini-3-pro-image-preview (Nano Banana Pro)
```

### –ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
- **Multi-turn chat** ‚Äî –ø–æ–º–Ω–∏—Ç –≤–µ—Å—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞
- **–ù–∞—Ç–∏–≤–Ω–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω–æ–∫** ‚Äî –≤–∏–¥–∏—Ç —Ä–µ—Ñ–µ—Ä–µ–Ω—Å—ã –±–µ–∑ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ Vision
- **–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–≤–æ–∏—Ö –∫–∞—Ä—Ç–∏–Ω–æ–∫** ‚Äî –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω—è—Ç—å —Ç–æ —á—Ç–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª
- **–¢–µ–∫—Å—Ç –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∞—Ö** ‚Äî –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ç–µ–∫—Å—Ç–∞
- **–î–æ 14 —Ä–µ—Ñ–µ—Ä–µ–Ω—Å-–∫–∞—Ä—Ç–∏–Ω–æ–∫** –≤ –æ–¥–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ
- **–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –¥–æ 4K**

### API —Ñ–æ—Ä–º–∞—Ç:
```javascript
import { GoogleGenAI } from "@google/genai";

const ai = new GoogleGenAI({ apiKey: process.env.GOOGLE_API_KEY });

// –°–æ–∑–¥–∞—ë–º —á–∞—Ç-—Å–µ—Å—Å–∏—é (–ù–ï –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã!)
const chat = ai.chats.create({
  model: "gemini-3-pro-image-preview",
  config: {
    responseModalities: ['TEXT', 'IMAGE'],
    systemInstruction: SYSTEM_PROMPT
  }
});

// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–∞—Ä—Ç–∏–Ω–∫–æ–π
const response = await chat.sendMessage([
  { text: "–°–¥–µ–ª–∞–π –ø–æ—Ö–æ–∂–∏–π –±–∞–Ω–Ω–µ—Ä –¥–ª—è –ò—Å–ø–∞–Ω–∏–∏" },
  { inlineData: { mimeType: "image/png", data: base64Image } }
]);

// –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç
for (const part of response.candidates[0].content.parts) {
  if (part.text) console.log(part.text);
  if (part.inlineData) saveImage(part.inlineData.data);
}
```

---

## –ß–¢–û –£–î–ê–õ–ò–¢–¨ (–º—ë—Ä—Ç–≤—ã–π –∫–æ–¥)

### Backend:
| –§–∞–π–ª | –°—Ç—Ä–æ–∫ | –ü—Ä–∏—á–∏–Ω–∞ |
|------|-------|---------|
| `backend/src/services/prompt.service.js` | 1225 | Claude Vision/Clarification –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω—ã |
| `backend/src/services/router.service.js` | 525 | –û–¥–Ω–∞ –º–æ–¥–µ–ª—å ‚Äî –Ω–µ –Ω—É–∂–µ–Ω —Ä–æ—É—Ç–∏–Ω–≥ |
| `backend/src/services/runware.service.js` | 401 | –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è |

### Frontend:
| –§–∞–π–ª | –ü—Ä–∏—á–∏–Ω–∞ |
|------|---------|
| `frontend/src/components/Chat/ClarificationQuestions.jsx` | Gemini —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø—Ä—è–º–æ –≤ —á–∞—Ç–µ |
| `frontend/src/components/Settings/SettingsModal.jsx` | –ó–∞–º–µ–Ω—è–µ–º –Ω–∞ inline –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ |

---

## –ß–¢–û –°–û–ó–î–ê–¢–¨/–ü–ï–†–ï–ü–ò–°–ê–¢–¨

### 1. Backend: `gemini.service.js` (–Ω–æ–≤—ã–π —Ñ–∞–π–ª, ~150 —Å—Ç—Ä–æ–∫)

```javascript
import { GoogleGenAI } from "@google/genai";
import fs from 'fs';
import path from 'path';
import { v4 as uuidv4 } from 'uuid';
import { config } from '../config/env.js';
import { log } from '../utils/logger.js';

const ai = new GoogleGenAI({ apiKey: config.googleApiKey });

// –•—Ä–∞–Ω–∏–ª–∏—â–µ —á–∞—Ç-—Å–µ—Å—Å–∏–π (chatId ‚Üí GeminiChat)
const chatSessions = new Map();

const SYSTEM_PROMPT = `–¢—ã ‚Äî –ø—Ä–µ–º–∏–∞–ª—å–Ω—ã–π AI-–¥–∏–∑–∞–π–Ω–µ—Ä —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –±–∞–Ω–Ω–µ—Ä–æ–≤.

## –¢–í–û–Ø –†–û–õ–¨
–°–æ–∑–¥–∞—ë—à—å –≤–∏–∑—É–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞ –¥–ª—è digital-—Ä–µ–∫–ª–∞–º—ã.
–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –∫–∞–∑–∏–Ω–æ, –≥–µ–º–±–ª–∏–Ω–≥, –±–µ—Ç—Ç–∏–Ω–≥, —Ñ–∏–Ω–∞–Ω—Å—ã, –º–æ–±–∏–ª—å–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

## –ö–ê–ö –†–ê–ë–û–¢–ê–¢–¨

### –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—Å—ã–ª–∞–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫—É:
1. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π: —Å—Ç–∏–ª—å, –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π, —Ü–≤–µ—Ç–∞, —Ç–µ–∫—Å—Ç, –∫–æ–º–ø–æ–∑–∏—Ü–∏—é
2. –ò—Å–ø–æ–ª—å–∑—É–π –∫–∞–∫ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
3. –°–æ—Ö—Ä–∞–Ω–∏ –∫–ª—é—á–µ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã (–ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π, –∞—Ç–º–æ—Å—Ñ–µ—Ä—É, —Å—Ç–∏–ª—å)

### –ö–æ–≥–¥–∞ –Ω—É–∂–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (—Ä–µ–∂–∏–º "–£–º–Ω—ã–π"):
–°–ø—Ä–æ—Å–∏ –ö–û–†–û–¢–ö–û (1-2 –≤–æ–ø—Ä–æ—Å–∞ –º–∞–∫—Å–∏–º—É–º):
- –†–∞–∑–º–µ—Ä –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω –∏ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- –ì–ï–û/—è–∑—ã–∫ —Ç–µ–∫—Å—Ç–∞
- –¢–µ–∫—Å—Ç –±–æ–Ω—É—Å–∞/–æ—Ñ—Ñ–µ—Ä–∞ –µ—Å–ª–∏ —ç—Ç–æ –∫–∞–∑–∏–Ω–æ/–±–µ—Ç—Ç–∏–Ω–≥
- –ù–∞–∑–≤–∞–Ω–∏–µ –±—Ä–µ–Ω–¥–∞/–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–æ—Ä–æ–ø–∏—Ç—Å—è (—Ä–µ–∂–∏–º "–ë—ã—Å—Ç—Ä—ã–π"):
–°–ª–æ–≤–∞ "–±—ã—Å—Ç—Ä–æ", "—Å—Ä–∞–∑—É", "–±–µ–∑ –≤–æ–ø—Ä–æ—Å–æ–≤", "–¥–∞–≤–∞–π", "[FAST]" ‚Üí –≥–µ–Ω–µ—Ä–∏—Ä—É–π —Å—Ä–∞–∑—É —Å —Ä–∞–∑—É–º–Ω—ã–º–∏ defaults:
- –†–∞–∑–º–µ—Ä: 1200x628 (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π)
- –Ø–∑—ã–∫: —Ä—É—Å—Å–∫–∏–π
- –°—Ç–∏–ª—å: –∫–∞–∫ –Ω–∞ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–µ –∏–ª–∏ –ø—Ä–µ–º–∏–∞–ª—å–Ω—ã–π —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è:
1. –°–æ–∑–¥–∞–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—ã—Å–æ–∫–æ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞
2. –ö–æ—Ä–æ—Ç–∫–æ –æ–ø–∏—à–∏ —á—Ç–æ —Å–¥–µ–ª–∞–ª (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
3. –ï—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏ –≤–∞—Ä–∏–∞–Ω—Ç —É–ª—É—á—à–µ–Ω–∏—è

## –°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø
- –†—É—Å—Å–∫–∏–π —è–∑—ã–∫
- –ö—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É
- –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ –Ω–æ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ
- –ë–µ–∑ –¥–ª–∏–Ω–Ω—ã—Ö –æ–±—ä—è—Å–Ω–µ–Ω–∏–π

## –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –ö–ê–†–¢–ò–ù–ö–ê–ú
- –¢–µ–∫—Å—Ç: —á—ë—Ç–∫–∏–π, —á–∏—Ç–∞–µ–º—ã–π, –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω—ã–π —Ñ–æ–Ω—É
- –ë–æ–Ω—É—Å—ã: –≤—ã–¥–µ–ª—è–π —Ä–∞–∑–º–µ—Ä–æ–º –∏ —Ü–≤–µ—Ç–æ–º (–∑–æ–ª–æ—Ç–æ–π, –±–µ–ª—ã–π –Ω–∞ —Ç—ë–º–Ω–æ–º)
- CTA –∫–Ω–æ–ø–∫–∏: –∑–∞–º–µ—Ç–Ω—ã–µ, —Å –ø—Ä–∏–∑—ã–≤–æ–º ("–ò–≥—Ä–∞—Ç—å", "–ü–æ–ª—É—á–∏—Ç—å", "–ó–∞–±—Ä–∞—Ç—å")
- –ü–µ—Ä—Å–æ–Ω–∞–∂–∏: —Å–æ—Ö—Ä–∞–Ω—è–π –∏–∑ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ—Ö–æ–∂–µ

## –†–ê–ó–ú–ï–†–´ (aspectRatio)
–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∫–∞–∑–∞–ª –∏–ª–∏ –ø–æ–Ω—è—Ç–Ω–æ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:
- "stories", "—Å—Ç–æ—Ä–∏—Å", "9:16" ‚Üí –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π 9:16
- "–ø–æ—Å—Ç", "–∫–≤–∞–¥—Ä–∞—Ç", "1:1" ‚Üí –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–π 1:1
- "–±–∞–Ω–Ω–µ—Ä", "—à–∏—Ä–æ–∫–∏–π", "16:9" ‚Üí –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π 16:9
- "fb", "facebook" ‚Üí 1200x628 (–ø—Ä–∏–º–µ—Ä–Ω–æ 16:9)
–ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π 16:9 –∫–∞–∫ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π.

## –ö–û–õ–ò–ß–ï–°–¢–í–û –í–ê–†–ò–ê–ù–¢–û–í
–ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ "[VARIANTS:N]" ‚Äî —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π N –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤.
–ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ ‚Äî —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π 2-3 –≤–∞—Ä–∏–∞–Ω—Ç–∞.`;

/**
 * –ü–æ–ª—É—á–∏—Ç—å –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å —á–∞—Ç-—Å–µ—Å—Å–∏—é
 */
export function getOrCreateChat(chatId) {
  if (!chatSessions.has(chatId)) {
    const chat = ai.chats.create({
      model: "gemini-3-pro-image-preview",
      config: {
        responseModalities: ['TEXT', 'IMAGE'],
        systemInstruction: SYSTEM_PROMPT
      }
    });
    chatSessions.set(chatId, chat);
    log.info('Created new Gemini chat session', { chatId });
  }
  return chatSessions.get(chatId);
}

/**
 * –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
 */
export async function sendMessage(chatId, text, images = [], settings = {}) {
  const chat = getOrCreateChat(chatId);
  
  // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
  let fullText = text || '';
  
  // –†–µ–∂–∏–º –±—ã—Å—Ç—Ä—ã–π
  if (settings.mode === 'fast') {
    fullText = '[FAST] ' + fullText;
  }
  
  // –†–∞–∑–º–µ—Ä (–µ—Å–ª–∏ –Ω–µ auto)
  if (settings.aspectRatio && settings.aspectRatio !== 'auto') {
    fullText += `\n[–†–∞–∑–º–µ—Ä: ${settings.aspectRatio}]`;
  }
  
  // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ (–µ—Å–ª–∏ –Ω–µ auto)
  if (settings.variants && settings.variants !== 'auto') {
    fullText += `\n[VARIANTS:${settings.variants}]`;
  }
  
  // –°–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
  const contents = [];
  
  if (fullText.trim()) {
    contents.push({ text: fullText });
  }
  
  // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Ä—Ç–∏–Ω–∫–∏
  for (const img of images) {
    contents.push({
      inlineData: {
        mimeType: img.mimeType || 'image/png',
        data: img.data // base64
      }
    });
  }
  
  log.info('Sending message to Gemini', { 
    chatId, 
    textLength: fullText.length,
    imagesCount: images.length,
    settings 
  });
  
  // –ö–æ–Ω—Ñ–∏–≥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
  const generationConfig = {
    imageConfig: {
      imageSize: settings.resolution || '2K' // '1K', '2K', '4K'
    }
  };
  
  // –î–æ–±–∞–≤–ª—è–µ–º aspectRatio –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω
  if (settings.aspectRatio && settings.aspectRatio !== 'auto') {
    generationConfig.imageConfig.aspectRatio = settings.aspectRatio;
  }
  
  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º
  const response = await chat.sendMessage(contents, { config: generationConfig });
  
  // –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç
  const result = {
    text: null,
    images: []
  };
  
  for (const part of response.candidates[0].content.parts) {
    if (part.text) {
      result.text = part.text;
    } else if (part.inlineData) {
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É
      const imageUrl = await saveBase64Image(part.inlineData.data, part.inlineData.mimeType);
      result.images.push({
        url: imageUrl,
        mimeType: part.inlineData.mimeType
      });
    }
  }
  
  log.info('Gemini response', { 
    chatId, 
    hasText: !!result.text,
    imagesCount: result.images.length 
  });
  
  return result;
}

/**
 * –°–æ—Ö—Ä–∞–Ω–∏—Ç—å base64 –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ —Ñ–∞–π–ª
 */
async function saveBase64Image(base64Data, mimeType = 'image/png') {
  const ext = mimeType?.includes('jpeg') ? '.jpg' : '.png';
  const filename = `${uuidv4()}${ext}`;
  const filepath = path.join(config.storagePath, filename);
  
  if (!fs.existsSync(config.storagePath)) {
    fs.mkdirSync(config.storagePath, { recursive: true });
  }
  
  const buffer = Buffer.from(base64Data, 'base64');
  fs.writeFileSync(filepath, buffer);
  
  log.debug('Saved image', { filename, sizeKB: Math.round(buffer.length / 1024) });
  
  return `/uploads/${filename}`;
}

/**
 * –£–¥–∞–ª–∏—Ç—å —á–∞—Ç-—Å–µ—Å—Å–∏—é
 */
export function deleteChat(chatId) {
  if (chatSessions.has(chatId)) {
    chatSessions.delete(chatId);
    log.info('Deleted Gemini chat session', { chatId });
  }
}

/**
 * Health check
 */
export async function checkHealth() {
  return {
    available: !!config.googleApiKey,
    model: 'gemini-3-pro-image-preview',
    features: ['multi-turn', 'image-understanding', 'image-generation', 'text-rendering']
  };
}

export default {
  getOrCreateChat,
  sendMessage,
  deleteChat,
  checkHealth
};
```

---

### 2. Backend: –£–ø—Ä–æ—Å—Ç–∏—Ç—å `generate.routes.js` (~200 —Å—Ç—Ä–æ–∫)

–£–¥–∞–ª–∏—Ç—å –≤—Å—é —Å–ª–æ–∂–Ω—É—é –ª–æ–≥–∏–∫—É clarification, deep thinking, router selection.
–û—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–æ—Å—Ç–æ–π endpoint:

```javascript
import { Router } from 'express';
import { db } from '../db/client.js';
import { authMiddleware } from '../middleware/auth.middleware.js';
import { uploadMiddleware, getFileUrl } from '../middleware/upload.middleware.js';
import { sendMessage, deleteChat } from '../services/gemini.service.js';
import { broadcastToChat } from '../websocket/handler.js';
import { log } from '../utils/logger.js';
import fs from 'fs';

const router = Router();
router.use(authMiddleware);

/**
 * POST /api/generate
 * –ì–ª–∞–≤–Ω—ã–π endpoint ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Gemini
 */
router.post('/', uploadMiddleware.single('reference'), async (req, res) => {
  try {
    const { prompt, chat_id, settings } = req.body;
    const userId = req.user.id;
    
    // –ü–∞—Ä—Å–∏–º settings –µ—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞
    const parsedSettings = typeof settings === 'string' ? JSON.parse(settings) : (settings || {});
    
    // –°–æ–∑–¥–∞—ë–º –∏–ª–∏ –ø–æ–ª—É—á–∞–µ–º —á–∞—Ç
    let chatId = chat_id ? parseInt(chat_id) : null;
    
    if (!chatId) {
      // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π —á–∞—Ç
      const chat = await db.getOne(
        'INSERT INTO chats (user_id, title) VALUES ($1, $2) RETURNING *',
        [userId, prompt?.substring(0, 50) || '–ù–æ–≤—ã–π —á–∞—Ç']
      );
      chatId = chat.id;
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userMessage = await db.getOne(
      'INSERT INTO messages (chat_id, role, content) VALUES ($1, $2, $3) RETURNING *',
      [chatId, 'user', prompt]
    );
    
    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫–∏
    const images = [];
    
    // –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
    if (req.file) {
      const base64 = fs.readFileSync(req.file.path).toString('base64');
      images.push({
        data: base64,
        mimeType: req.file.mimetype
      });
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–∞—Ä—Ç–∏–Ω–∫–æ–π
      await db.query(
        'UPDATE messages SET image_url = $1 WHERE id = $2',
        [getFileUrl(req.file.filename), userMessage.id]
      );
    }
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å —á–µ—Ä–µ–∑ WebSocket
    broadcastToChat(chatId, {
      type: 'status',
      phase: 'generating',
      message: '–ì–µ–Ω–µ—Ä–∏—Ä—É—é...'
    });
    
    // –í—ã–∑—ã–≤–∞–µ–º Gemini
    const result = await sendMessage(chatId, prompt, images, parsedSettings);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç AI
    const assistantMessage = await db.getOne(
      'INSERT INTO messages (chat_id, role, content, images) VALUES ($1, $2, $3, $4) RETURNING *',
      [chatId, 'assistant', result.text, JSON.stringify(result.images)]
    );
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —á–µ—Ä–µ–∑ WebSocket
    broadcastToChat(chatId, {
      type: 'message',
      message: {
        id: assistantMessage.id,
        role: 'assistant',
        content: result.text,
        images: result.images,
        created_at: assistantMessage.created_at
      }
    });
    
    broadcastToChat(chatId, { type: 'complete' });
    
    // HTTP –æ—Ç–≤–µ—Ç
    res.json({
      success: true,
      chat_id: chatId,
      message: {
        id: assistantMessage.id,
        role: 'assistant',
        content: result.text,
        images: result.images
      }
    });
    
  } catch (error) {
    log.error('Generate error', { error: error.message });
    res.status(500).json({ error: error.message });
  }
});

/**
 * DELETE /api/generate/chat/:id
 * –£–¥–∞–ª–∏—Ç—å —á–∞—Ç –∏ –æ—Å–≤–æ–±–æ–¥–∏—Ç—å —Å–µ—Å—Å–∏—é Gemini
 */
router.delete('/chat/:id', async (req, res) => {
  try {
    const chatId = parseInt(req.params.id);
    
    // –£–¥–∞–ª—è–µ–º —Å–µ—Å—Å–∏—é Gemini
    deleteChat(chatId);
    
    // –£–¥–∞–ª—è–µ–º –∏–∑ –ë–î
    await db.query('DELETE FROM messages WHERE chat_id = $1', [chatId]);
    await db.query('DELETE FROM chats WHERE id = $1 AND user_id = $2', [chatId, req.user.id]);
    
    res.json({ success: true });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

export default router;
```

---

### 3. Backend: –û–±–Ω–æ–≤–∏—Ç—å `config/env.js`

–î–æ–±–∞–≤–∏—Ç—å:
```javascript
export const config = {
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ
  googleApiKey: process.env.GOOGLE_API_KEY,  // –ù–û–í–û–ï ‚Äî –¥–ª—è Gemini API
  // googleCloudProject –∏ googleCredentialsJson –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ fallback –¥–ª—è Vertex AI
};
```

---

### 4. Frontend: –£–ø—Ä–æ—Å—Ç–∏—Ç—å `useChat.js`

–£–±—Ä–∞—Ç—å:
- `pendingClarification` ‚Äî –Ω–µ –Ω—É–∂–Ω–æ
- `deepThinkingData` ‚Äî –Ω–µ –Ω—É–∂–Ω–æ  
- –í—Å–µ —Ñ–∞–∑—ã –∫—Ä–æ–º–µ: `idle`, `generating`, `complete`, `error`
- –§—É–Ω–∫—Ü–∏—é `checkNeedsClarification` ‚Äî –Ω–µ –Ω—É–∂–Ω–∞
- –§—É–Ω–∫—Ü–∏—é `processAnswers` ‚Äî –Ω–µ –Ω—É–∂–Ω–∞

–û—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–æ—Å—Ç–æ–π flow:
```javascript
// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
sendMessage: async (prompt, imageFile) => {
  set({ isGenerating: true, phase: 'generating' });
  
  const formData = new FormData();
  formData.append('prompt', prompt);
  formData.append('chat_id', get().currentChat?.id);
  formData.append('settings', JSON.stringify(get().settings));
  if (imageFile) formData.append('reference', imageFile);
  
  const response = await fetch('/api/generate', {
    method: 'POST',
    body: formData
  });
  
  // –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ WebSocket
}
```

---

### 5. Frontend: –ü–µ—Ä–µ–¥–µ–ª–∞—Ç—å `InputArea.jsx`

**–£–±—Ä–∞—Ç—å:**
- 3 —Ä–µ–∂–∏–º–∞ (smart/fast/deep) ‚Üí 2 —Ä–µ–∂–∏–º–∞ (smart/fast)
- –û—Ç–¥–µ–ª—å–Ω—ã–π Vision –∞–Ω–∞–ª–∏–∑ —Å —Ç–µ–≥–∞–º–∏
- –°–ª–æ–∂–Ω—É—é –ª–æ–≥–∏–∫—É

**–î–æ–±–∞–≤–∏—Ç—å:**
- Inline –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞—é—Ç—Å—è –ø–æ –∫–ª–∏–∫—É)
- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –£–º–Ω—ã–π/–ë—ã—Å—Ç—Ä—ã–π

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ UI:**
```jsx
<div className="input-container">
  {/* –ü—Ä–µ–≤—å—é –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏ (–ø—Ä–æ—Å—Ç–æ–µ, –±–µ–∑ Vision —Ç–µ–≥–æ–≤) */}
  {attachedImage && (
    <div className="attached-preview">
      <img src={preview} />
      <button onClick={clear}>‚úï</button>
    </div>
  )}
  
  {/* –û—Å–Ω–æ–≤–Ω–æ–π input */}
  <div className="input-row">
    <button onClick={attachFile}>üìé</button>
    <button onClick={toggleSettings}>‚öôÔ∏è</button>
    <textarea placeholder="–û–ø–∏—à–∏—Ç–µ –±–∞–Ω–Ω–µ—Ä..." />
    <div className="mode-toggle">
      <button className={mode === 'smart' ? 'active' : ''}>–£–º–Ω—ã–π</button>
      <button className={mode === 'fast' ? 'active' : ''}>‚ö°</button>
    </div>
    <button onClick={send}>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </div>
  
  {/* –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (—Å–∫—Ä—ã—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) */}
  {showSettings && (
    <div className="settings-panel">
      <div className="setting-row">
        <label>–†–∞–∑–º–µ—Ä:</label>
        <div className="options">
          <button className={aspectRatio === 'auto' ? 'active' : ''}>Auto</button>
          <button className={aspectRatio === '1:1' ? 'active' : ''}>1:1</button>
          <button className={aspectRatio === '16:9' ? 'active' : ''}>16:9</button>
          <button className={aspectRatio === '9:16' ? 'active' : ''}>9:16</button>
        </div>
      </div>
      <div className="setting-row">
        <label>–í–∞—Ä–∏–∞–Ω—Ç—ã:</label>
        <div className="options">
          <button className={variants === 'auto' ? 'active' : ''}>Auto</button>
          <button>1</button>
          <button>2</button>
          <button>3</button>
          <button>4</button>
        </div>
      </div>
      <div className="setting-row">
        <label>–ö–∞—á–µ—Å—Ç–≤–æ:</label>
        <div className="options">
          <button>1K</button>
          <button className="active">2K</button>
          <button>4K</button>
        </div>
      </div>
    </div>
  )}
</div>
```

---

### 6. Frontend: –£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª—ã

```bash
rm frontend/src/components/Chat/ClarificationQuestions.jsx
rm frontend/src/components/Settings/SettingsModal.jsx
```

–£–±—Ä–∞—Ç—å –∏–º–ø–æ—Ä—Ç—ã —ç—Ç–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –∏–∑ –¥—Ä—É–≥–∏—Ö —Ñ–∞–π–ª–æ–≤.

---

### 7. Frontend: –û–±–Ω–æ–≤–∏—Ç—å `Message.jsx`

–£–ø—Ä–æ—Å—Ç–∏—Ç—å ‚Äî —É–±—Ä–∞—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É clarification, deep thinking.
–û—Å—Ç–∞–≤–∏—Ç—å:
- –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
- –ö–∞—Ä—Ç–∏–Ω–∫–∏ (–≥–∞–ª–µ—Ä–µ—è)
- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏

---

## ENV –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

```env
# –ù–æ–≤–æ–µ (Gemini API)
GOOGLE_API_KEY=your_gemini_api_key

# –ú–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å (–±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω—ã)
# ANTHROPIC_API_KEY=...  ‚Äî Claude –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

# –û—Å—Ç–∞–≤–∏—Ç—å –µ—Å–ª–∏ –Ω—É–∂–µ–Ω fallback –Ω–∞ Vertex AI
GOOGLE_CLOUD_PROJECT=...
GOOGLE_APPLICATION_CREDENTIALS_JSON=...
```

---

## DEFAULTS

| –ù–∞—Å—Ç—Ä–æ–π–∫–∞ | Default –∑–Ω–∞—á–µ–Ω–∏–µ | –õ–æ–≥–∏–∫–∞ |
|-----------|------------------|--------|
| `mode` | `smart` | AI —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –µ—Å–ª–∏ –Ω—É–∂–Ω–æ |
| `aspectRatio` | `auto` | AI –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∏–∑ –ø—Ä–æ–º–ø—Ç–∞ |
| `variants` | `auto` | AI —Ä–µ—à–∞–µ—Ç (–æ–±—ã—á–Ω–æ 2-3) |
| `resolution` | `2K` | –•–æ—Ä–æ—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ –±–µ–∑ –æ–≤–µ—Ä–∫–∏–ª–ª–∞ |

---

## –ß—Ç–æ –ù–ï –¢–†–û–ì–ê–¢–¨

–≠—Ç–∏ —Ñ–∞–π–ª—ã —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –Ω–µ –º–µ–Ω—è–π –∏—Ö –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏:

- `frontend/src/components/Chat/ChatWindow.jsx` ‚Äî –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —á–∞—Ç–∞
- `frontend/src/components/Chat/Message.jsx` ‚Äî —Ç–æ–ª—å–∫–æ —É–ø—Ä–æ—Å—Ç–∏—Ç—å
- `frontend/src/components/Layout/Sidebar.jsx` ‚Äî —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
- `frontend/src/components/Layout/Header.jsx` ‚Äî —à–∞–ø–∫–∞
- `frontend/src/pages/ChatPage.jsx` ‚Äî layout —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- `frontend/src/styles/globals.css` ‚Äî —Å—Ç–∏–ª–∏ (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ)
- `backend/src/routes/auth.routes.js` ‚Äî –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
- `backend/src/routes/chat.routes.js` ‚Äî CRUD —á–∞—Ç–æ–≤
- `backend/src/db/*` ‚Äî –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- `backend/src/websocket/handler.js` ‚Äî WebSocket

---

## –ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

1. **Backend —Å–Ω–∞—á–∞–ª–∞:**
   - –°–æ–∑–¥–∞—Ç—å `gemini.service.js`
   - –û–±–Ω–æ–≤–∏—Ç—å `config/env.js`
   - –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å `generate.routes.js`
   - –£–¥–∞–ª–∏—Ç—å `prompt.service.js`, `router.service.js`, `runware.service.js`
   - –¢–µ—Å—Ç: `curl` –∑–∞–ø—Ä–æ—Å –∫ –Ω–æ–≤–æ–º—É endpoint

2. **Frontend –ø–æ—Ç–æ–º:**
   - –£–ø—Ä–æ—Å—Ç–∏—Ç—å `useChat.js`
   - –ü–µ—Ä–µ–¥–µ–ª–∞—Ç—å `InputArea.jsx`
   - –£–ø—Ä–æ—Å—Ç–∏—Ç—å `Message.jsx`
   - –£–¥–∞–ª–∏—Ç—å `ClarificationQuestions.jsx`, `SettingsModal.jsx`
   - –¢–µ—Å—Ç: –ø–æ–ª–Ω—ã–π flow –≤ –±—Ä–∞—É–∑–µ—Ä–µ

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

–ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å:

1. ‚úÖ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ—Ñ–µ—Ä–µ–Ω—Å ‚Üí AI –≤–∏–¥–∏—Ç –∏ –ø–æ–Ω–∏–º–∞–µ—Ç –µ–≥–æ
2. ‚úÖ –ù–∞–ø–∏—Å–∞—Ç—å "—Å–¥–µ–ª–∞–π –¥–ª—è –ò—Å–ø–∞–Ω–∏–∏" ‚Üí –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–æ—Ö–æ–∂–∏–π –±–∞–Ω–Ω–µ—Ä
3. ‚úÖ –ù–∞–ø–∏—Å–∞—Ç—å "—Ñ–æ–Ω —Ç–µ–º–Ω–µ–µ" ‚Üí —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç –°–í–û–Æ –∫–∞—Ä—Ç–∏–Ω–∫—É
4. ‚úÖ AI –ø–æ–º–Ω–∏—Ç –≤–µ—Å—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞
5. ‚úÖ –†–µ–∂–∏–º "–ë—ã—Å—Ç—Ä—ã–π" ‚Üí –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –±–µ–∑ –≤–æ–ø—Ä–æ—Å–æ–≤
6. ‚úÖ –†–µ–∂–∏–º "–£–º–Ω—ã–π" ‚Üí —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –µ—Å–ª–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –∏–Ω—Ñ–æ
7. ‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞–∑–º–µ—Ä–∞/–≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —Ä–∞–±–æ—Ç–∞—é—Ç
