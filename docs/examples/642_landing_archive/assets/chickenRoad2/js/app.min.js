class ChickenRoadGame{constructor(){this.game=document.getElementById("game"),this.char=document.getElementById("game-char"),this.field=document.getElementById("game-field"),this.sectors=document.querySelectorAll(".game__sector"),this.spinButton=document.getElementById("go-btn"),this.cashButton=document.getElementById("cash-btn"),this.winButton=document.getElementById("win-button-modal"),this.modal=document.getElementById("modal"),this.controls=document.getElementById("game-controls"),this.balance=document.getElementById("balance"),this.modalBalance=document.getElementById("modal-balance"),this.modalMultiplier=document.getElementById("modal-multiplier"),this.charMultiplier=document.getElementById("char-multiplier"),this.winSoundName=document.body.dataset.winSound||"1",this.isUseSound="false"!==document.body.dataset.useSound,this.charMultiplierElement=document.getElementById("char-multiplier-element"),this.effectsContainer=document.getElementById("effects"),this.effectsImage=document.getElementById("effects-image"),this.spinSound=new Audio("assets/general/sound/chicken-road-2-button-click.mp3"),this.jumpSound=new Audio("assets/general/sound/chicken-road-2-jump.mp3"),this.winSound=new Audio(`assets/general/sound/winSound/${this.winSoundName}.mp3`),this.loseSound=new Audio("assets/general/sound/chicken-road-2-lose.mp3"),this.rate=this.game.dataset.rate,this.spins=Number(this.game.dataset.spins),this.crashes=this.game.dataset.crashes,this.multipliers=this.game.dataset.multipliers,this.sectorWidth=this.sectors[0].offsetWidth,this.charMoves=0,this.currentStep=0,this.firstStepIndex=1,this.lastStepIndex=7,this.stepTime=700,this.spaceScrolled=window.innerWidth,this.isDesktop=window.innerWidth>768,this.currentSpin=1,this.failStep=null}initGame(){this.showNextSector(this.currentStep),this.calculateFontSize(this.spinButton),this.calculateFontSize(this.cashButton),this.calculateFontSize(this.winButton,{threshold:30,step:.02,minPercent:.6}),window.addEventListener("placementOpenModal",()=>{this.showModal()}),this.spinButton.addEventListener("click",()=>{this.initSpin()}),this.cashButton.addEventListener("click",()=>{this.handleCashOut()})}getFailStep(){this.failStep=Number(this.crashes.split(",")[this.currentSpin-1])||null}initSpin(){window.isMobile&&window.pushPlacement&&!window.firstClick&&0===this.currentStep?window.dispatchEvent(new CustomEvent("placementFirstClick",{detail:[this.spin.bind(this)]})):this.spin()}spin(){this.currentStep+=1,this.getFailStep(),this.playSound(this.spinSound),this.isDesktop&&(this.currentStep===this.firstStepIndex||this.currentStep===this.lastStepIndex||this.spaceScrolled>this.field.offsetWidth)&&(this.charMoves+=1),this.currentSpin<this.spins&&this.currentStep===this.failStep?this.handleFail():(this.playSound(this.jumpSound,100),this.moveChar(this.currentStep),this.moveField(this.currentStep),this.disableControls(this.stepTime),setTimeout(()=>{this.showNextSector(this.currentStep),this.showActiveSector(this.currentStep),this.showFinishedSector(this.currentStep),this.updateBalance(this.currentStep),this.updateMultiplier(this.currentStep)},this.stepTime/2),this.currentStep===this.firstStepIndex&&(this.setControlPanelActivated(),this.setCashOutActivated(),setTimeout(()=>{this.showCharMultiplier()},this.stepTime)),this.currentStep===this.lastStepIndex&&this.handleWin())}handleWin(){setTimeout(()=>{this.hideCharMultiplier()},this.stepTime/2),setTimeout(()=>{this.charMoves+=1.3,this.moveChar(this.currentStep+1.3),this.moveField(this.currentStep+1.3),this.showFinishedSector(this.currentStep+1),this.showEffects(1e3),this.playSound(this.winSound,1e3),this.triggerShowModal(1e3),this.disableControls(1e4)},this.stepTime)}handleCashOut(){this.showEffects(),this.triggerShowModal(),this.playSound(this.winSound),this.disableControls(1e4)}handleFail(){this.setCashOutDisabled(),this.disableControls(1500),this.moveLoseChar(this.currentStep),this.moveField(this.currentStep),this.hideCharMultiplier(),this.playSound(this.loseSound,500),this.showLoseSector(this.currentStep),this.showFinishedSector(this.currentStep),setTimeout(()=>{this.resetGame()},1500)}resetGame(){this.currentSpin+=1,this.currentStep=0,this.charMoves=0,this.spaceScrolled=window.innerWidth,this.char.classList.remove("is--lose"),this.sectors.forEach(t=>{t&&(t.classList.remove("is--lose"),t.classList.remove("is--active"),t.classList.remove("is--finished"))}),this.char.style.transform="translateX(0px)",this.field.style.transform="translateX(0px)",this.updateBalance(this.currentStep),this.updateMultiplier(this.currentStep),this.showNextSector(this.currentStep)}showNextSector(t){const e=this.sectors[t];e&&e.classList.add("is--next")}showActiveSector(t){const e=this.sectors[t-1];e&&(e.classList.add("is--active"),e.classList.remove("is--next"))}showLoseSector(t){const e=this.sectors[t-1];e&&(e.classList.add("is--lose"),e.classList.remove("is--next"))}showFinishedSector(t){const e=this.sectors[t-2];e&&(e.classList.add("is--finished"),e.classList.remove("is--next"),e.classList.remove("is--active"))}moveField(t){const e=this.sectorWidth*(t-this.charMoves);this.field.style.transform=`translateX(-${e}px)`,this.spaceScrolled+=e}moveChar(t){if(this.char.classList.add("is--active"),t===this.firstStepIndex||t>=this.lastStepIndex||this.spaceScrolled>this.field.offsetWidth){const t=this.sectorWidth*this.charMoves;this.char.style.transform=`translateX(${t}px)`}setTimeout(()=>{this.char.classList.remove("is--active")},this.stepTime)}moveLoseChar(t){if(this.char.classList.add("is--lose"),this.isDesktop&&(1===t||7===t||this.spaceScrolled>this.field.offsetWidth)){const t=this.sectorWidth*this.charMoves;this.char.style.transform=`translateX(${t}px)`}}updateBalance(t){const e=this.multipliers.split(","),s=0!==t?(this.rate*e[t-1]).toFixed(2):"0";this.balance.innerText=s,this.modalBalance&&(this.modalBalance.innerText=s)}updateMultiplier(t){const e=this.multipliers.split(","),s=0!==t?e[t-1]:"0";this.modalMultiplier&&(this.modalMultiplier.innerText=s),this.charMultiplier.innerText=s}showCharMultiplier(){this.charMultiplierElement.classList.add("is--active")}hideCharMultiplier(){this.charMultiplierElement.classList.remove("is--active")}setControlPanelActivated(){this.controls.classList.add("is--active")}setCashOutActivated(){this.controls.classList.add("is--cashout-active")}setCashOutDisabled(){this.controls.classList.remove("is--cashout-active")}disableControls(t){this.spinButton.setAttribute("disabled",""),t&&setTimeout(()=>{this.spinButton.removeAttribute("disabled")},t)}showEffects(t=0,e=1500){this.effectsContainer.classList.add("visible"),setTimeout(()=>{const t=document.createElement("div");t.style.backgroundImage=`url(${this.effectsImage.src})`,t.classList.add("effects__block"),this.effectsContainer.appendChild(t),setTimeout(()=>{this.effectsContainer.classList.remove("visible"),this.effectsContainer.classList.add("hidden")},e)},t)}showModal(){document.body.classList.add("is--modal-open"),this.modal.classList.add("is--active")}playSound(t,e=0){this.isUseSound&&setTimeout(()=>{t.muted=!1,t.currentTime=0,t.play().catch(t=>{console.error("Помилка при відтворенні аудіо: ",t)})},e)}triggerShowModal(t=0){setTimeout(()=>{window.dispatchEvent(new Event("placementOpenModal"))},t)}calculateFontSize(t,e={threshold:25,step:.03,minPercent:.6}){if(!t)return;const s=t.querySelectorAll("span");s&&s.forEach(t=>{const s=String(t.innerText).length,i=window.getComputedStyle(t),h=parseFloat(i.getPropertyValue("font-size")),n=h,a=h*e.minPercent,o=Math.max(0,s-e.threshold),r=Math.max(n-o*(h*e.step),a);t.style.fontSize=`${r}px`})}}document.addEventListener("DOMContentLoaded",()=>{(new ChickenRoadGame).initGame()});