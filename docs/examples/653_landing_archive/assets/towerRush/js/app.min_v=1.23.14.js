class TowerRushGame{constructor(){this.game=document.getElementById("game"),this.gameField=document.getElementById("game-field"),this.gameTower=document.getElementById("game-tower"),this.gameBalance=document.getElementById("game-balance"),this.gameMultiplier=document.getElementById("game-multiplier"),this.gameResults=document.getElementById("game-results"),this.spinButton=document.getElementById("go-btn"),this.winButton=document.getElementById("win-button-modal"),this.cashButton=document.getElementById("game-cash"),this.modal=document.getElementById("modal"),this.effectsContainer=document.getElementById("effects"),this.effectsImage=document.getElementById("effects-image"),this.winSoundName=document.body.dataset.winSound||"1",this.isUseSound="false"!==document.body.dataset.useSound,this.rate=this.game.dataset.rate,this.spins=Number(this.game.dataset.spins),this.crashes=this.game.dataset.crashes,this.currentSpin=1,this.failStep=null,this.maxSteps=4,this.currentStep=0,this.currentMultiplier=0,this.multipliers=[2.5,.65,1.75,3]}initGame(){this.initSounds(),this.setNextStep(),[this.spinButton,this.winButton,this.cashButton].forEach(t=>{this.calculateFontSize(t)}),window.addEventListener("placementOpenModal",()=>{this.showModal()}),this.spinButton.addEventListener("click",()=>{this.initSpin()}),this.cashButton.addEventListener("click",()=>{this.showEffects(),this.triggerShowModal(),this.playSound(this.winSound)})}initSounds(){this.isUseSound&&(this.winSound=new Howl({src:[`assets/general/sound/winSound/${this.winSoundName}.mp3`],preload:!0,html5:!0,volume:1}),this.dropSound=new Howl({src:["assets/general/sound/tower-rush-drop.mp3"],preload:!0,html5:!0,volume:1}))}initSpin(){window.isMobile&&window.pushPlacement&&!window.firstClick&&0===this.currentStep?window.dispatchEvent(new CustomEvent("placementFirstClick",{detail:[this.spin.bind(this)]})):this.spin()}async spin(){this.currentStep+=1,this.setStarted(),this.getFailStep(),this.setDisabled(),this.currentSpin<this.spins&&this.currentStep===this.failStep?await this.handleFail():(this.currentStep<=this.maxSteps&&(this.playSound(this.dropSound),this.startStep(),await this.dropBuild(),this.updateResults(),this.updateBalance(),this.stopStep()),this.currentStep<this.maxSteps&&(this.setNextStep(),setTimeout(()=>{this.unsetDisabled()},500)),this.currentStep>=this.maxSteps&&(this.setWin(),this.playSound(this.winSound,500),this.showEffects(500),this.triggerShowModal(500)))}async handleFail(){this.setLose(),this.startStep(),this.playSound(this.dropSound),await this.dropBuild(!0),setTimeout(()=>{this.resetGame()},1e3)}resetGame(){this.currentSpin+=1,this.currentStep=0,this.failStep=null,this.currentMultiplier=0,this.game.classList.remove("is--started"),this.game.classList.remove("is--active"),this.game.classList.remove("is--win"),this.game.classList.remove("is--lose"),this.game.classList.remove("is--step-1"),this.game.classList.remove("is--step-2"),this.game.classList.remove("is--step-3"),this.game.classList.remove("is--step-4"),this.game.classList.remove("is--multiplier"),this.gameBalance.innerText="0",this.gameMultiplier.innerText="0",this.gameResults.innerHTML="";const t=this.game.querySelector(".game__field-tower-hook");t&&(t.style.animation="none",t.offsetWidth,t.style.animation="");const e=this.gameTower.querySelectorAll(".game__field-tower-item, .game__field-tower-item-build");e&&e.forEach(t=>{t.style.animation="none",t.offsetWidth,t.style.animation="",t.removeAttribute("style")}),setTimeout(()=>{this.stopStep(),setTimeout(()=>{this.game.classList.add("is--step-1"),this.unsetDisabled()},250)},250)}setWin(){this.game.classList.add("is--win")}setLose(){this.game.classList.add("is--lose")}setStarted(){this.game.classList.add("is--started")}setDisabled(){this.game.classList.add("is--disabled")}unsetDisabled(){this.game.classList.remove("is--disabled")}startStep(){this.game.classList.add("is--active")}stopStep(){this.game.classList.remove("is--active")}setNextStep(){this.game.classList.add(`is--step-${this.currentStep+1}`)}getFailStep(){this.failStep=Number(this.crashes.split(",")[this.currentSpin-1])||null}updateBalance(){this.currentMultiplier=this.currentMultiplier+this.multipliers[this.currentStep-1],this.gameBalance.innerText=Number(this.rate*this.currentMultiplier).toFixed(2)}updateResults(){const t=this.multipliers[this.currentStep-1];this.gameMultiplier.innerText=this.multipliers[this.currentStep-1],this.game.classList.add("is--multiplier"),setTimeout(()=>{this.game.classList.remove("is--multiplier");const e=document.createElement("span");e.innerText=`x${t}`,this.gameResults.appendChild(e)},1e3)}async dropBuild(t=!1){const e=this.game.querySelector(`.game__field-tower-item.is--${this.currentStep}`),s=this.game.querySelector(`.game__field-tower-item.is--${this.currentStep} .game__field-tower-item-build`),i=this.game.querySelector(`.game__field-tower-item.is--${this.currentStep-1}`),a=this.getElementTransform(e),n=this.getElementTransform(s),o=i.getBoundingClientRect(),r=this.gameField.offsetHeight-o.top;if(t){s.style=`transform: translate(${n.x}px, ${n.y}px) rotate(${n.angle}deg); animation: 500ms fallBuildPart1 linear forwards;`,e.style=`transform: translate(${a.x}px, ${a.y}px) rotate(${a.angle}deg); animation: 500ms fallBuildPart1 linear forwards; bottom: ${r}px;`,await this.waitForTransition(e);const t=document.createElement("img");t.src="assets/towerRush/img/explode.webp",t.classList.add("game__field-tower-drop"),t.style.bottom=`${r}px`,this.gameTower.appendChild(t),setTimeout(()=>{t.remove()},300),s.style=`transform: translate(${n.x}px, ${n.y}px) rotate(${n.angle}deg); animation: 750ms fallBuildPart2 linear forwards;`,e.style=`transform: translate(${a.x}px, ${a.y}px) rotate(${a.angle}deg); animation: 750ms fallBuildPart2 linear forwards; bottom: ${r}px;`,await this.waitForTransition(e)}else{s.style=`transform: translate(${n.x}px, ${n.y}px) rotate(${n.angle}deg); animation: 500ms stableBuild linear forwards;`,e.style=`transform: translate(${a.x}px, ${a.y}px) rotate(${a.angle}deg); animation: 500ms stableBuild linear forwards; bottom: ${r}px;`,await this.waitForTransition(e);const t=document.createElement("img");t.src="assets/towerRush/img/drop.gif",t.classList.add("game__field-tower-drop"),t.style.bottom=`${r}px`,this.gameTower.appendChild(t),setTimeout(()=>{t.remove()},800)}}getElementTransform(t){const e=window.getComputedStyle(t).transform;if("none"!==e){const t=e.match(/matrix.*\((.+)\)/)[1].split(", "),s=parseFloat(t[0]),i=parseFloat(t[1]);return{x:parseFloat(t[4]),y:parseFloat(t[5]),angle:Math.round(Math.atan2(i,s)*(180/Math.PI))}}}async waitForTransition(t){return new Promise(e=>{const s=()=>{t.removeEventListener("animationend",s),e()};t.addEventListener("animationend",s)})}showEffects(t=0,e=1500){this.effectsContainer.classList.add("visible"),setTimeout(()=>{const t=document.createElement("div");t.style.backgroundImage=`url(${this.effectsImage.src})`,t.classList.add("effects__block"),this.effectsContainer.appendChild(t),setTimeout(()=>{this.effectsContainer.classList.remove("visible"),this.effectsContainer.classList.add("hidden")},e)},t)}showModal(){document.body.classList.add("is--modal-open"),this.modal.classList.add("is--active")}playSound(t,e=0,s=1){this.isUseSound&&setTimeout(()=>{t.volume(s),t.play()},e)}stopSound(t){t.stop()}triggerShowModal(t=0){setTimeout(()=>{window.dispatchEvent(new Event("placementOpenModal"))},t)}calculateFontSize(t,e={threshold:20,step:.02,minPercent:.5}){if(!t)return;const s=t.querySelectorAll("span");s&&s.forEach(t=>{const s=String(t.innerText).length,i=window.getComputedStyle(t),a=parseFloat(i.getPropertyValue("font-size")),n=a,o=a*e.minPercent,r=Math.max(0,s-e.threshold),l=Math.max(n-r*(a*e.step),o);t.style.fontSize=`${l}px`})}}document.addEventListener("DOMContentLoaded",()=>{(new TowerRushGame).initGame()});